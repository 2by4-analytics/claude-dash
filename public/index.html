<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Media Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0c0f; --surface: #111418; --surface2: #181c22;
    --border: #1e2530; --border2: #252d3a;
    --accent: #00d4aa; --accent2: #0099ff; --warn: #ff6b35;
    --text: #e2e8f0; --text2: #8899aa; --text3: #4a5568;
    --good: #00d4aa; --bad: #ff4757;
    --mono: 'IBM Plex Mono', monospace; --sans: 'IBM Plex Sans', sans-serif;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: var(--sans); font-size: 13px; line-height: 1.5; min-height: 100vh; overflow-x: hidden; }

  /* HEADER */
  .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 10px 16px; position: sticky; top: 0; z-index: 100; }
  .header-top { display: flex; align-items: center; gap: 12px; }
  .logo { font-family: var(--mono); font-weight: 600; font-size: 14px; color: var(--accent); letter-spacing: 0.05em; flex-shrink: 0; }
  .logo span { color: var(--text2); font-weight: 400; }
  .header-client { flex: 1; min-width: 0; }
  select, input[type="date"] { background: var(--surface2); border: 1px solid var(--border2); color: var(--text); font-family: var(--sans); font-size: 13px; padding: 8px 10px; border-radius: 4px; outline: none; cursor: pointer; width: 100%; }
  select:focus, input[type="date"]:focus { border-color: var(--accent); }
  select option { background: #1a1f2e; }
  .header-controls { display: flex; align-items: center; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
  .date-presets { display: flex; gap: 4px; flex-wrap: wrap; flex: 1; }
  .preset-btn { background: transparent; border: 1px solid var(--border2); color: var(--text2); font-family: var(--mono); font-size: 11px; padding: 6px 10px; border-radius: 3px; cursor: pointer; transition: all 0.15s; white-space: nowrap; }
  .preset-btn:hover, .preset-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(0, 212, 170, 0.08); }
  .date-inputs { display: flex; gap: 6px; align-items: center; }
  .date-inputs input[type="date"] { width: auto; font-size: 12px; padding: 6px 8px; }
  .btn { background: var(--accent); color: #000; border: none; padding: 8px 18px; border-radius: 4px; font-family: var(--mono); font-size: 12px; font-weight: 600; cursor: pointer; letter-spacing: 0.05em; transition: opacity 0.15s; white-space: nowrap; }
  .btn:hover { opacity: 0.85; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-secondary { background: transparent; color: var(--text2); border: 1px solid var(--border2); }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); opacity: 1; }

  /* MAIN */
  .main { padding: 16px; }

  /* SUMMARY CARDS */
  .summary-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 16px; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 12px 14px; }
  .card-label { font-family: var(--mono); font-size: 10px; font-weight: 500; color: var(--text3); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 4px; }
  .card-value { font-family: var(--mono); font-size: 20px; font-weight: 600; color: var(--text); }
  .card-value.good { color: var(--good); }
  .card-value.warn { color: var(--warn); }

  /* ALERTS */
  .alerts-panel { background: var(--surface); border: 1px solid #5a3a1a; border-radius: 6px; padding: 14px; margin-bottom: 16px; }
  .alerts-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
  .alerts-title { font-family: var(--mono); font-size: 11px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: #f59e0b; }
  .alerts-subtitle { font-size: 11px; color: var(--text3); }
  .alerts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 10px; }
  .alert-card { background: #1a1208; border: 1px solid #3d2a0a; border-radius: 5px; padding: 10px 12px; }
  .alert-card.both { border-left: 3px solid #ef4444; }
  .alert-level { font-family: var(--mono); font-size: 9px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text3); margin-bottom: 4px; }
  .alert-name { font-size: 13px; font-weight: 500; color: var(--text); margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .alert-metrics { display: flex; gap: 14px; flex-wrap: wrap; }
  .alert-metric { display: flex; flex-direction: column; gap: 2px; }
  .alert-metric-label { font-size: 9px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.08em; }
  .alert-metric-value { font-family: var(--mono); font-size: 13px; font-weight: 600; color: var(--text); }
  .alert-metric-value.bad { color: #ef4444; }

  /* STATUS */
  .status-bar { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: var(--surface); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 12px; font-family: var(--mono); font-size: 11px; color: var(--text2); }
  .status-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text3); flex-shrink: 0; }
  .status-dot.loading { background: var(--accent2); animation: pulse 1s ease-in-out infinite; }
  .status-dot.ok { background: var(--good); }
  .status-dot.error { background: var(--bad); }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
  #statusText { word-break: break-word; }
  .table-actions { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
  .table-actions span { font-family: var(--mono); font-size: 11px; color: var(--text3); }

  /* DESKTOP TABLE */
  .table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; overflow: auto; }
  table { width: 100%; border-collapse: collapse; min-width: 1200px; }
  thead { position: sticky; top: 0; z-index: 10; background: var(--surface2); }
  th { font-family: var(--mono); font-size: 10px; font-weight: 500; color: var(--text3); letter-spacing: 0.08em; text-transform: uppercase; padding: 10px 12px; text-align: right; white-space: nowrap; border-bottom: 1px solid var(--border); }
  th:first-child { text-align: left; position: sticky; left: 0; background: var(--surface2); z-index: 11; }
  .col-group-header { font-family: var(--mono); font-size: 9px; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; padding: 5px 12px; border-bottom: 1px solid var(--border); }
  .col-group-fb { color: var(--accent2); }
  .col-group-coc { color: var(--warn); }
  .col-group-derived { color: var(--accent); }
  tr.data-row { border-bottom: 1px solid rgba(30, 37, 48, 0.6); transition: background 0.1s; }
  tr.data-row:hover { background: rgba(255,255,255,0.02); }
  tr.data-row:last-child { border-bottom: none; }
  td { padding: 8px 12px; text-align: right; font-family: var(--mono); font-size: 12px; color: var(--text); white-space: nowrap; }
  td:first-child { text-align: left; position: sticky; left: 0; background: var(--surface); z-index: 5; }
  tr.data-row:hover td:first-child { background: #131820; }
  .row-level-0 td:first-child { padding-left: 12px; }
  .row-level-1 td:first-child { padding-left: 28px; }
  .row-level-2 td:first-child { padding-left: 46px; }
  .row-level-3 td:first-child { padding-left: 64px; }
  .row-level-0 { background: rgba(0, 212, 170, 0.04); }
  .row-level-0 td { font-weight: 600; border-top: 1px solid rgba(0, 212, 170, 0.15); }
  .row-level-1 td { color: var(--text); }
  .row-level-2 td { color: var(--text2); }
  .row-level-3 td { color: var(--text3); font-size: 11px; }
  .toggle-btn { background: none; border: none; cursor: pointer; color: var(--text3); font-size: 10px; padding: 0 4px 0 0; line-height: 1; transition: color 0.15s, transform 0.15s; display: inline-block; width: 14px; }
  .toggle-btn:hover { color: var(--accent); }
  .toggle-btn.collapsed { transform: rotate(-90deg); }
  .row-name { display: flex; align-items: center; gap: 4px; }
  .level-tag { font-family: var(--mono); font-size: 9px; padding: 1px 5px; border-radius: 2px; font-weight: 600; letter-spacing: 0.05em; flex-shrink: 0; }
  .tag-account { background: rgba(0, 212, 170, 0.12); color: var(--accent); }
  .tag-campaign { background: rgba(0, 153, 255, 0.12); color: var(--accent2); }
  .tag-adset { background: rgba(255, 107, 53, 0.12); color: var(--warn); }
  .tag-ad { background: rgba(255,255,255,0.05); color: var(--text3); }
  .val-roas { color: var(--text); }
  .val-roas.good { color: var(--good); }
  .val-roas.bad { color: var(--bad); }
  td.empty { color: var(--text3); }
  .skeleton { animation: shimmer 1.5s infinite; background: linear-gradient(90deg, var(--surface2) 25%, #1e2530 50%, var(--surface2) 75%); background-size: 200% 100%; border-radius: 3px; height: 12px; display: inline-block; }
  @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
  .empty-state { text-align: center; padding: 60px 24px; color: var(--text3); font-family: var(--mono); font-size: 13px; }
  .empty-state .big { font-size: 32px; margin-bottom: 12px; }

  /* MOBILE CARDS */
  .mobile-cards { display: none; flex-direction: column; gap: 6px; }
  .m-card { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
  .m-card.level-0 { border-left: 3px solid var(--accent); }
  .m-card.level-1 { border-left: 3px solid var(--accent2); margin-left: 6px; }
  .m-card.level-2 { border-left: 3px solid var(--warn); margin-left: 12px; }
  .m-card.level-3 { border-left: 3px solid var(--border2); margin-left: 18px; }
  .m-card-header { display: flex; align-items: center; gap: 8px; padding: 10px 12px; cursor: pointer; -webkit-tap-highlight-color: transparent; }
  .m-card-header:active { background: rgba(255,255,255,0.02); }
  .m-card-toggle { font-size: 10px; color: var(--text3); transition: transform 0.2s; flex-shrink: 0; width: 14px; text-align: center; }
  .m-card-toggle.collapsed { transform: rotate(-90deg); }
  .m-card-info { flex: 1; min-width: 0; }
  .m-card-tag-name { display: flex; align-items: center; gap: 6px; }
  .m-card-name { font-size: 13px; font-weight: 500; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .m-card.level-0 .m-card-name { font-weight: 700; color: var(--accent); font-size: 14px; }
  .m-card.level-2 .m-card-name { color: var(--text2); }
  .m-card.level-3 .m-card-name { color: var(--text3); font-size: 12px; }
  .m-card-quick { display: flex; gap: 12px; flex-shrink: 0; }
  .m-card-qs { text-align: right; }
  .m-card-qs-label { font-family: var(--mono); font-size: 8px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.08em; }
  .m-card-qs-value { font-family: var(--mono); font-size: 13px; font-weight: 600; }
  .m-card-detail { display: none; border-top: 1px solid var(--border); }
  .m-card-detail.open { display: block; }
  .m-card-metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: var(--border); }
  .m-metric { background: var(--surface2); padding: 8px 10px; text-align: center; }
  .m-metric-label { font-family: var(--mono); font-size: 8px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 2px; }
  .m-metric-value { font-family: var(--mono); font-size: 13px; font-weight: 600; color: var(--text); }
  .m-metric-value.good { color: var(--good); }
  .m-metric-value.bad { color: var(--bad); }
  .m-metric-value.muted { color: var(--text3); }
  .m-metric-sub { font-size: 9px; margin-top: 1px; }
  .m-card-children { display: none; flex-direction: column; gap: 4px; padding: 4px 0; }
  .m-card-children.open { display: flex; }

  /* RESPONSIVE */
  @media (max-width: 768px) {
    .main { padding: 10px; }
    .header { padding: 10px 12px; }
    .date-inputs input[type="date"] { width: 110px; font-size: 11px; padding: 6px 6px; }
    .summary-cards { grid-template-columns: repeat(2, 1fr); gap: 6px; margin-bottom: 12px; }
    .card { padding: 10px 12px; }
    .card-value { font-size: 17px; }
    .card-label { font-size: 9px; }
    .table-wrap { display: none !important; }
    .mobile-cards { display: flex !important; }
    .alerts-grid { grid-template-columns: 1fr; }
  }
  @media (min-width: 769px) {
    .header { padding: 10px 20px; }
    .header-top { gap: 16px; }
    .header-client { flex: 0 0 220px; }
    .header-controls { margin-top: 0; flex-wrap: nowrap; }
    .main { padding: 20px 24px; }
    .summary-cards { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
    .mobile-cards { display: none !important; }
    .table-wrap { display: block !important; }
  }
  @media (max-width: 420px) {
    .date-presets { gap: 3px; }
    .preset-btn { padding: 5px 7px; font-size: 10px; }
    .m-card.level-1 { margin-left: 4px; }
    .m-card.level-2 { margin-left: 8px; }
    .m-card.level-3 { margin-left: 12px; }
  }
</style>
</head>
<body>
<header class="header">
  <div class="header-top">
    <div class="logo">MEDIA<span>/</span>DASH</div>
    <div class="header-client"><select id="clientSelect"><option value="">Loading clients...</option></select></div>
  </div>
  <div class="header-controls">
    <div class="date-presets">
      <button class="preset-btn" data-preset="today">Today</button>
      <button class="preset-btn active" data-preset="yesterday">Yesterday</button>
      <button class="preset-btn" data-preset="7d">7D</button>
      <button class="preset-btn" data-preset="14d">14D</button>
      <button class="preset-btn" data-preset="30d">30D</button>
      <button class="preset-btn" data-preset="mtd">MTD</button>
    </div>
    <div class="date-inputs">
      <input type="date" id="startDate" />
      <input type="date" id="endDate" />
    </div>
    <button class="btn" id="loadBtn">RUN</button>
  </div>
</header>
<main class="main">
  <div class="summary-cards" id="summaryCards" style="display:none"></div>
  <div class="alerts-panel" id="alertsPanel" style="display:none">
    <div class="alerts-header"><span class="alerts-title">⚠ CPP Alerts</span><span class="alerts-subtitle" id="alertsSubtitle"></span></div>
    <div class="alerts-grid" id="alertsGrid"></div>
  </div>
  <div class="status-bar" id="statusBar"><div class="status-dot" id="statusDot"></div><span id="statusText">Select a client and date range, then click RUN</span></div>
  <div class="table-actions" id="tableActions" style="display:none"><span>Expand:</span><button class="btn-secondary preset-btn" id="expandAll">All</button><button class="btn-secondary preset-btn" id="collapseAll">None</button></div>
  <div class="table-wrap" id="tableWrap"><div class="empty-state"><div class="big">⬡</div><div>No data loaded yet</div></div></div>
  <div class="mobile-cards" id="mobileCards"></div>
</main>
<script>
// STATE
let currentData = null;
const collapsed = new Set();
let cppTargets = {};
let priorData = null;

// INIT
async function init() {
  const y = new Date(); y.setDate(y.getDate() - 1);
  const ys = y.toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });
  document.getElementById('startDate').value = ys;
  document.getElementById('endDate').value = ys;
  await loadClients();
  setupListeners();
}

function fmt(d) { return d.toLocaleDateString('en-CA', { timeZone: 'America/Chicago' }); }

async function loadClients() {
  try {
    const res = await fetch('/api/clients');
    const { clients } = await res.json();
    const sel = document.getElementById('clientSelect');
    sel.innerHTML = clients.length
      ? clients.map(c => '<option value="'+c.id+'">'+c.name+'</option>').join('')
      : '<option value="">No clients configured</option>';
    cppTargets = {};
    for (const c of clients) for (const a of c.adAccounts || []) if (a.cppTarget) cppTargets[a.fbAdAccountId] = parseFloat(a.cppTarget);
  } catch (e) { document.getElementById('clientSelect').innerHTML = '<option value="">Error loading clients</option>'; }
}

function setupListeners() {
  document.getElementById('loadBtn').addEventListener('click', loadDashboard);
  document.querySelectorAll('.preset-btn[data-preset]').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.preset-btn[data-preset]').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      applyPreset(btn.dataset.preset);
    });
  });
  var ea = document.getElementById('expandAll');
  if (ea) ea.addEventListener('click', function() { collapsed.clear(); renderAll(); });
  var ca = document.getElementById('collapseAll');
  if (ca) ca.addEventListener('click', function() {
    if (!currentData) return;
    currentData.adAccounts.forEach(function(acct) {
      collapsed.add('acct-'+acct.fbAdAccountId);
      (acct.campaigns||[]).forEach(function(camp) {
        collapsed.add('camp-'+acct.fbAdAccountId+'-'+camp.name);
        (camp.adsets||[]).forEach(function(adset) {
          collapsed.add('adset-'+acct.fbAdAccountId+'-'+camp.name+'-'+adset.name);
        });
      });
    });
    renderAll();
  });
}

function renderAll() { renderTable(currentData); renderMobileCards(currentData); }

function applyPreset(preset) {
  var today = new Date();
  var yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
  var start, end;
  switch (preset) {
    case 'today': start = end = fmt(today); break;
    case 'yesterday': start = end = fmt(yesterday); break;
    case '7d': start = fmt(new Date(yesterday.getTime() - 6*864e5)); end = fmt(yesterday); break;
    case '14d': start = fmt(new Date(yesterday.getTime() - 13*864e5)); end = fmt(yesterday); break;
    case '30d': start = fmt(new Date(yesterday.getTime() - 29*864e5)); end = fmt(yesterday); break;
    case 'mtd': start = fmt(new Date(today.getFullYear(), today.getMonth(), 1)); end = fmt(yesterday); break;
  }
  if (start) document.getElementById('startDate').value = start;
  if (end) document.getElementById('endDate').value = end;
}

// LOAD DATA
async function loadDashboard() {
  var clientId = document.getElementById('clientSelect').value;
  var startDate = document.getElementById('startDate').value;
  var endDate = document.getElementById('endDate').value;
  if (!clientId || !startDate || !endDate) { setStatus('error', 'Please select a client and date range'); return; }

  setStatus('loading', 'Fetching FB + COC data for '+startDate+' → '+endDate+'...');
  document.getElementById('loadBtn').disabled = true;
  document.getElementById('alertsPanel').style.display = 'none';
  showLoadingSkeleton();

  try {
    var results = await Promise.all([
      fetch('/api/dashboard/'+clientId+'?startDate='+startDate+'&endDate='+endDate),
      fetch('/api/prior/'+clientId+'?startDate='+startDate+'&endDate='+endDate).catch(function() { return null; })
    ]);
    var res = results[0]; var priorRes = results[1];
    if (!res.ok) throw new Error('Server error: '+res.status);
    var data = await res.json();
    currentData = data;
    priorData = (priorRes && priorRes.ok) ? await priorRes.json() : null;

    if (data.errors && data.errors.length) {
      setStatus('error', 'Loaded with '+data.errors.length+' error(s): '+data.errors.map(function(e){return e.error}).join(', '));
    } else {
      var priorLabel = priorData ? ' · vs '+priorData.startDate+' → '+priorData.endDate : '';
      setStatus('ok', 'Loaded '+data.adAccounts.length+' ad account(s) · '+startDate+' → '+endDate+priorLabel);
    }
    renderSummaryCards(data);
    renderAll();
    renderAlerts(data);
    document.getElementById('tableActions').style.display = 'flex';
  } catch (e) {
    setStatus('error', 'Failed to load: '+e.message);
    showError(e.message);
  } finally {
    document.getElementById('loadBtn').disabled = false;
  }
}

function setStatus(state, msg) {
  document.getElementById('statusDot').className = 'status-dot ' + state;
  document.getElementById('statusText').textContent = msg;
}

// SUMMARY CARDS
function renderSummaryCards(data) {
  var c = document.getElementById('summaryCards'); c.style.display = 'grid';
  var ts=0,tsa=0,tr=0,tp=0;
  for (var i=0;i<data.adAccounts.length;i++) {
    var a=data.adAccounts[i]; ts+=a.fbSpend||0;
    var coc=a.cocTotals; if(coc){tsa+=coc.sales||0;tr+=coc.salesTotal||0;tp+=coc.partials||0;}
  }
  var roas=ts>0?tr/ts:0, cpp=tsa>0?ts/tsa:0, aov=tsa>0?tr/tsa:0, conv=(tp+tsa)>0?(tsa/(tp+tsa)*100):0;
  c.innerHTML='<div class="card"><div class="card-label">FB Spend</div><div class="card-value">'+fmtC(ts)+'</div></div>'
    +'<div class="card"><div class="card-label">Revenue</div><div class="card-value">'+fmtC(tr)+'</div></div>'
    +'<div class="card"><div class="card-label">ROAS</div><div class="card-value '+(roas>=1?'good':'warn')+'">'+roas.toFixed(2)+'x</div></div>'
    +'<div class="card"><div class="card-label">Sales</div><div class="card-value">'+tsa.toLocaleString()+'</div></div>'
    +'<div class="card"><div class="card-label">CPP</div><div class="card-value">'+fmtC(cpp)+'</div></div>'
    +'<div class="card"><div class="card-label">AOV</div><div class="card-value">'+fmtC(aov)+'</div></div>'
    +'<div class="card"><div class="card-label">Conv Rate</div><div class="card-value">'+conv.toFixed(1)+'%</div></div>'
    +'<div class="card"><div class="card-label">Partials</div><div class="card-value">'+tp.toLocaleString()+'</div></div>';
}

// DESKTOP TABLE RENDER
function renderTable(data) {
  if (!data || !data.adAccounts || !data.adAccounts.length) {
    document.getElementById('tableWrap').innerHTML = '<div class="empty-state"><div class="big">⬡</div><div>No data returned</div></div>';
    return;
  }
  var rows = [];
  for (var i=0;i<data.adAccounts.length;i++) {
    var acct = data.adAccounts[i];
    var acctKey = 'acct-'+acct.fbAdAccountId;
    var acctC = collapsed.has(acctKey);
    var coc = acct.cocTotals || {};
    var acctRoas = acct.fbSpend>0&&coc.salesTotal ? coc.salesTotal/acct.fbSpend : 0;
    rows.push(buildRow(acctKey,0,'ACCOUNT','tag-account',acct.cocCampaignName,acct.fbAdAccountId,!!(acct.campaigns&&acct.campaigns.length),acctC,acct.fbSpend,coc,acctRoas,coc.sales>0?acct.fbSpend/coc.sales:0,coc.sales>0?coc.salesTotal/coc.sales:0,acct.fbAdAccountId,'',''));
    if (acctC) continue;
    for (var j=0;j<(acct.campaigns||[]).length;j++) {
      var camp = acct.campaigns[j];
      var campKey = 'camp-'+acct.fbAdAccountId+'-'+camp.name;
      var campC = collapsed.has(campKey);
      rows.push(buildRow(campKey,1,'CAMPAIGN','tag-campaign',camp.name,'',!!(camp.adsets&&camp.adsets.length),campC,camp.fbSpend,camp.cocData||{},camp.roas,camp.cpp,camp.aov,'','',''));
      if (campC) continue;
      for (var k=0;k<(camp.adsets||[]).length;k++) {
        var adset = camp.adsets[k];
        var adsetKey = 'adset-'+acct.fbAdAccountId+'-'+camp.name+'-'+adset.name;
        var adsetC = collapsed.has(adsetKey);
        rows.push(buildRow(adsetKey,2,'ADSET','tag-adset',adset.name,'',!!(adset.ads&&adset.ads.length),adsetC,adset.fbSpend,adset.cocData||{},adset.roas,adset.cpp,adset.aov,acct.fbAdAccountId,camp.name,''));
        if (adsetC) continue;
        for (var l=0;l<(adset.ads||[]).length;l++) {
          var ad = adset.ads[l];
          rows.push(buildRow('ad-'+acct.fbAdAccountId+'-'+camp.name+'-'+adset.name+'-'+ad.name,3,'AD','tag-ad',ad.name,'',false,false,ad.fbSpend,ad.cocData||{},ad.roas,ad.cpp,ad.aov,acct.fbAdAccountId,camp.name,adset.name));
        }
      }
    }
  }

  document.getElementById('tableWrap').innerHTML = '<table><thead>'
    +'<tr><th rowspan="2" style="text-align:left;min-width:240px">Name</th>'
    +'<th class="col-group-header col-group-fb" colspan="1" style="text-align:center">FB</th>'
    +'<th class="col-group-header col-group-coc" colspan="8" style="text-align:center">CHECKOUT CHAMP</th>'
    +'<th class="col-group-header col-group-derived" colspan="5" style="text-align:center">DERIVED</th></tr>'
    +'<tr><th>Spend</th><th>Partials</th><th>Conv%</th><th>Declines</th><th>Dec%</th><th>Sales</th><th>Sales%</th><th>Revenue</th><th>Net Rev</th><th>Avg Ticket</th><th>ROAS</th><th>CPP</th><th>Δ CPP</th><th>AOV</th></tr>'
    +'</thead><tbody>'+rows.join('')+'</tbody></table>';

  document.querySelectorAll('.toggle-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      var key = btn.dataset.key;
      if (collapsed.has(key)) collapsed.delete(key); else collapsed.add(key);
      renderAll();
    });
  });
}

function buildRow(key,level,tag,tagClass,name,subname,hasChildren,isCollapsed,fbSpend,coc,roas,cpp,aov,adAccountId,campaignName,adsetName) {
  var tog = hasChildren ? '<button class="toggle-btn '+(isCollapsed?'collapsed':'')+'" data-key="'+key+'">▾</button>' : '<span style="display:inline-block;width:14px"></span>';
  var rc = roas>0 ? (roas>=1.5?'good':roas>=1?'':'bad') : '';
  function cell(v,cls) { return (v!=null&&v!==0&&v!==''&&v!=='---') ? '<td class="'+(cls||'')+'">'+v+'</td>' : '<td class="empty">—</td>'; }

  var cppHtml = '—';
  if (cpp && cpp > 0) {
    var target = cppTargets[adAccountId] || null;
    var cls = '';
    if (target) cls = cpp <= target ? 'style="color:var(--good)"' : 'style="color:var(--bad)"';
    cppHtml = '<span '+cls+'>'+fmtC(cpp)+'</span>';
  } else { cppHtml = '<span style="color:var(--text3)">—</span>'; }

  var deltaCppHtml = '<span style="color:var(--text3)">—</span>';
  if (cpp && cpp > 0) {
    var priorCpp = getPriorCpp(adAccountId, campaignName, adsetName, level===3 ? name : null);
    if (priorCpp !== null) {
      var delta = cpp - priorCpp;
      var pct = Math.round((delta / priorCpp) * 100);
      var sign = delta > 0 ? '+' : '';
      var dcls = delta > 0 ? 'color:var(--bad)' : 'color:var(--good)';
      deltaCppHtml = '<span style="'+dcls+'">'+sign+fmtC(Math.abs(delta))+' ('+sign+pct+'%)</span>';
    }
  }

  return '<tr class="data-row row-level-'+level+'" data-key="'+key+'">'
    +'<td><div class="row-name">'+tog+'<span class="level-tag '+tagClass+'">'+tag+'</span><span title="'+esc(name)+'">'+truncate(name,level===3?30:40)+'</span>'+(subname?'<span style="color:var(--text3);font-size:10px;margin-left:6px">'+subname+'</span>':'')+'</div></td>'
    +cell(fmtC(fbSpend))+cell(fmtN(coc.partials))+cell(fmtP(coc.convRate))+cell(fmtN(coc.declines))+cell(fmtP(coc.declineRate))
    +cell(fmtN(coc.sales))+cell(fmtP(coc.salesRate))+cell(fmtC(coc.salesTotal))+cell(fmtC(coc.netRevenue))+cell(fmtC(coc.avgTicket))
    +'<td class="val-roas '+rc+'">'+(roas>0?roas.toFixed(2)+'x':'—')+'</td>'
    +'<td>'+cppHtml+'</td><td>'+deltaCppHtml+'</td>'
    +cell(aov>0?fmtC(aov):null)
    +'</tr>';
}

// MOBILE CARD RENDER
function renderMobileCards(data) {
  var container = document.getElementById('mobileCards');
  if (!data||!data.adAccounts||!data.adAccounts.length) { container.innerHTML='<div class="empty-state"><div class="big">⬡</div><div>No data returned</div></div>'; return; }
  container.innerHTML = '';

  for (var i=0;i<data.adAccounts.length;i++) {
    var acct=data.adAccounts[i], acctKey='acct-'+acct.fbAdAccountId, coc=acct.cocTotals||{};
    var ar=acct.fbSpend>0&&coc.salesTotal?coc.salesTotal/acct.fbSpend:0;
    var acctCard=buildMCard(acctKey,0,'ACCT','tag-account',acct.cocCampaignName,acct.fbSpend,coc,ar,coc.sales>0?acct.fbSpend/coc.sales:0,coc.sales>0?coc.salesTotal/coc.sales:0,!!(acct.campaigns&&acct.campaigns.length),acct.fbAdAccountId,'','');

    if (!collapsed.has(acctKey)&&acct.campaigns&&acct.campaigns.length) {
      var w1=mkCW();
      for (var j=0;j<acct.campaigns.length;j++) {
        var camp=acct.campaigns[j],campKey='camp-'+acct.fbAdAccountId+'-'+camp.name;
        var campCard=buildMCard(campKey,1,'CAMP','tag-campaign',camp.name,camp.fbSpend,camp.cocData||{},camp.roas,camp.cpp,camp.aov,!!(camp.adsets&&camp.adsets.length),acct.fbAdAccountId,camp.name,'');
        if (!collapsed.has(campKey)&&camp.adsets&&camp.adsets.length) {
          var w2=mkCW();
          for (var k=0;k<camp.adsets.length;k++) {
            var adset=camp.adsets[k],adsetKey='adset-'+acct.fbAdAccountId+'-'+camp.name+'-'+adset.name;
            var adsetCard=buildMCard(adsetKey,2,'ASET','tag-adset',adset.name,adset.fbSpend,adset.cocData||{},adset.roas,adset.cpp,adset.aov,!!(adset.ads&&adset.ads.length),acct.fbAdAccountId,camp.name,adset.name);
            if (!collapsed.has(adsetKey)&&adset.ads&&adset.ads.length) {
              var w3=mkCW();
              for (var l=0;l<adset.ads.length;l++) {
                var ad=adset.ads[l];
                w3.appendChild(buildMCard('ad-'+acct.fbAdAccountId+'-'+camp.name+'-'+adset.name+'-'+ad.name,3,'AD','tag-ad',ad.name,ad.fbSpend,ad.cocData||{},ad.roas,ad.cpp,ad.aov,false,acct.fbAdAccountId,camp.name,adset.name));
              }
              adsetCard.appendChild(w3);
            }
            w2.appendChild(adsetCard);
          }
          campCard.appendChild(w2);
        }
        w1.appendChild(campCard);
      }
      acctCard.appendChild(w1);
    }
    container.appendChild(acctCard);
  }
}

function mkCW(){var d=document.createElement('div');d.className='m-card-children open';return d;}

function buildMCard(key,level,tag,tagClass,name,fbSpend,coc,roas,cpp,aov,hasChildren,adAccountId,campaignName,adsetName) {
  var card=document.createElement('div');
  card.className='m-card level-'+level;
  var spend=fbSpend||0, roasVal=roas||0, cppVal=cpp||0, aovVal=aov||0;
  var rc=roasVal>0?(roasVal>=1.5?'good':roasVal>=1?'':'bad'):'muted';
  var isColl=collapsed.has(key);

  // CPP color
  var cppCls='';
  var target=cppTargets[adAccountId]||null;
  if(cppVal>0&&target) cppCls=cppVal<=target?'good':'bad';

  // Delta CPP
  var deltaCppHtml='';
  if(cppVal>0){
    var pc=getPriorCpp(adAccountId,campaignName,adsetName,level===3?name:null);
    if(pc!==null){
      var d=cppVal-pc,pct=Math.round((d/pc)*100),s=d>0?'+':'',dc=d>0?'bad':'good';
      deltaCppHtml='<div class="m-metric-sub" style="color:var(--'+dc+')">'+s+fmtC(Math.abs(d))+' ('+s+pct+'%)</div>';
    }
  }

  var togHtml=hasChildren?'<div class="m-card-toggle '+(isColl?'collapsed':'')+'">▾</div>':'';

  card.innerHTML='<div class="m-card-header">'+togHtml
    +'<div class="m-card-info"><div class="m-card-tag-name"><span class="level-tag '+tagClass+'">'+tag+'</span><div class="m-card-name" title="'+esc(name)+'">'+esc(name)+'</div></div></div>'
    +'<div class="m-card-quick">'
    +'<div class="m-card-qs"><div class="m-card-qs-label">ROAS</div><div class="m-card-qs-value '+rc+'">'+(roasVal>0?roasVal.toFixed(2)+'x':'—')+'</div></div>'
    +'<div class="m-card-qs"><div class="m-card-qs-label">Spend</div><div class="m-card-qs-value">'+fmtShort(spend)+'</div></div>'
    +'</div></div>'
    +'<div class="m-card-detail"><div class="m-card-metrics">'
    +'<div class="m-metric"><div class="m-metric-label">FB Spend</div><div class="m-metric-value">'+(fmtC(spend)||'—')+'</div></div>'
    +'<div class="m-metric"><div class="m-metric-label">Revenue</div><div class="m-metric-value">'+(fmtC(coc.salesTotal)||'—')+'</div></div>'
    +'<div class="m-metric"><div class="m-metric-label">Net Rev</div><div class="m-metric-value">'+(fmtC(coc.netRevenue)||'—')+'</div></div>'
    +'<div class="m-metric"><div class="m-metric-label">Sales</div><div class="m-metric-value">'+((coc.sales||0)>0?coc.sales.toLocaleString():'—')+'</div></div>'
    +'<div class="m-metric"><div class="m-metric-label">Partials</div><div class="m-metric-value">'+((coc.partials||0)>0?coc.partials.toLocaleString():'—')+'</div></div>'
    +'<div class="m-metric"><div class="m-metric-label">Declines</div><div class="m-metric-value">'+((coc.declines||0)>0?coc.declines.toLocaleString():'—')+'</div></div>'
    +'<div class="m-metric"><div class="m-metric-label">ROAS</div><div class="m-metric-value '+rc+'">'+(roasVal>0?roasVal.toFixed(2)+'x':'—')+'</div></div>'
    +'<div class="m-metric"><div class="m-metric-label">CPP</div><div class="m-metric-value '+cppCls+'">'+(cppVal>0?fmtC(cppVal):'—')+deltaCppHtml+'</div></div>'
    +'<div class="m-metric"><div class="m-metric-label">AOV</div><div class="m-metric-value">'+(aovVal>0?fmtC(aovVal):'—')+'</div></div>'
    +'<div class="m-metric"><div class="m-metric-label">Conv%</div><div class="m-metric-value">'+((coc.convRate||0)>0?fmtP(coc.convRate):'—')+'</div></div>'
    +'<div class="m-metric"><div class="m-metric-label">Dec%</div><div class="m-metric-value">'+((coc.declineRate||0)>0?fmtP(coc.declineRate):'—')+'</div></div>'
    +'<div class="m-metric"><div class="m-metric-label">Avg Ticket</div><div class="m-metric-value">'+((coc.avgTicket||0)>0?fmtC(coc.avgTicket):'—')+'</div></div>'
    +'</div></div>';

  card.querySelector('.m-card-header').addEventListener('click', function() {
    card.querySelector(':scope > .m-card-detail').classList.toggle('open');
    if (hasChildren) {
      var tog=card.querySelector(':scope > .m-card-header .m-card-toggle');
      if(tog)tog.classList.toggle('collapsed');
      var ch=card.querySelector(':scope > .m-card-children');
      if(ch)ch.classList.toggle('open');
      if(collapsed.has(key))collapsed.delete(key);else collapsed.add(key);
    }
  });
  return card;
}

// ALERTS
async function renderAlerts(data) {
  var panel=document.getElementById('alertsPanel'),grid=document.getElementById('alertsGrid'),subtitle=document.getElementById('alertsSubtitle');
  if(!Object.keys(cppTargets).length){
    try{var r=await fetch('/api/clients');var d=await r.json();for(var c of d.clients)for(var a of c.adAccounts||[])if(a.cppTarget)cppTargets[a.fbAdAccountId]=parseFloat(a.cppTarget);}catch(e){}
  }
  if(!Object.keys(cppTargets).length){panel.style.display='none';return;}
  var flagged=[];
  for(var acct of data.adAccounts||[]){
    var target=cppTargets[acct.fbAdAccountId];if(!target)continue;
    for(var camp of acct.campaigns||[]){
      for(var adset of camp.adsets||[]){
        if((adset.fbSpend||0)>=25&&(adset.cpp||0)>target)flagged.push({level:'adset',acctName:acct.cocCampaignName,name:adset.name,cpp:adset.cpp,target:target,spend:adset.fbSpend,priorCpp:getPriorCpp(acct.fbAdAccountId,camp.name,adset.name,null),overTarget:adset.cpp-target});
        for(var ad of adset.ads||[]){
          if((ad.fbSpend||0)>=25&&(ad.cpp||0)>target)flagged.push({level:'ad',acctName:acct.cocCampaignName,name:ad.name,cpp:ad.cpp,target:target,spend:ad.fbSpend,priorCpp:getPriorCpp(acct.fbAdAccountId,camp.name,adset.name,ad.name),overTarget:ad.cpp-target});
        }
      }
    }
  }
  if(!flagged.length){panel.style.display='none';return;}
  flagged.sort(function(a,b){return b.overTarget-a.overTarget;});
  subtitle.textContent=flagged.length+' item'+(flagged.length!==1?'s':'')+' above CPP target · spend ≥$25';
  grid.innerHTML=flagged.map(function(item){
    var delta=item.priorCpp!==null?item.cpp-item.priorCpp:null;
    var deltaStr=delta!==null?'<span style="color:'+(delta>0?'var(--bad)':'var(--good)')+'">'+(delta>0?'▲':'▼')+' '+(delta>0?'+':'')+fmtC(Math.abs(delta))+' vs prior</span>':'';
    return '<div class="alert-card both"><div class="alert-level">'+(item.level==='adset'?'⬡ ADSET':'● AD')+' · '+item.acctName+'</div>'
      +'<div class="alert-name" title="'+item.name+'">'+truncate(item.name,36)+'</div>'
      +'<div class="alert-metrics">'
      +'<div class="alert-metric"><div class="alert-metric-label">CPP</div><div class="alert-metric-value bad">'+fmtC(item.cpp)+'</div></div>'
      +'<div class="alert-metric"><div class="alert-metric-label">Target</div><div class="alert-metric-value">'+fmtC(item.target)+'</div></div>'
      +'<div class="alert-metric"><div class="alert-metric-label">Over By</div><div class="alert-metric-value bad">+'+fmtC(item.overTarget)+'</div></div>'
      +'<div class="alert-metric"><div class="alert-metric-label">Spend</div><div class="alert-metric-value">'+fmtC(item.spend)+'</div></div>'
      +'</div>'+(deltaStr?'<div style="margin-top:8px;font-size:10px">'+deltaStr+'</div>':'')+'</div>';
  }).join('');
  panel.style.display='block';
}

// PRIOR CPP LOOKUP
function getPriorCpp(adAccountId,campaignName,adsetName,adName){
  if(!priorData)return null;
  var acct=(priorData.adAccounts||[]).find(function(a){return a.fbAdAccountId===adAccountId;});
  if(!acct)return null;
  if(!campaignName){var coc=acct.cocTotals;return(coc&&coc.sales>0)?acct.fbSpend/coc.sales:null;}
  var camp=(acct.campaigns||[]).find(function(c){return c.name===campaignName;});
  if(!camp)return null;
  if(!adsetName)return camp.cpp>0?camp.cpp:null;
  var adset=(camp.adsets||[]).find(function(a){return a.name===adsetName;});
  if(!adset)return null;
  if(!adName)return adset.cpp>0?adset.cpp:null;
  var ad=(adset.ads||[]).find(function(a){return a.name===adName;});
  return ad&&ad.cpp>0?ad.cpp:null;
}

// LOADING/ERROR
function showLoadingSkeleton(){
  var cols=15;
  function sr(w){return '<tr class="data-row"><td><div class="skeleton" style="width:'+w+'%">&nbsp;</div></td>'+Array(cols-1).fill('<td><div class="skeleton" style="width:60px">&nbsp;</div></td>').join('')+'</tr>';}
  document.getElementById('tableWrap').innerHTML='<table><tbody>'+sr(40)+sr(30)+sr(25)+sr(20)+sr(30)+sr(25)+'</tbody></table>';
  document.getElementById('mobileCards').innerHTML=Array(4).fill('<div class="m-card level-0" style="padding:14px"><div class="skeleton" style="width:60%;height:14px;margin-bottom:8px">&nbsp;</div><div class="skeleton" style="width:40%;height:12px">&nbsp;</div></div>').join('');
}
function showError(msg){
  var h='<div class="empty-state" style="color:var(--bad)"><div class="big">✕</div><div>'+msg+'</div><div style="margin-top:8px;font-size:11px;color:var(--text3)">Check your environment variables and API credentials</div></div>';
  document.getElementById('tableWrap').innerHTML=h;
  document.getElementById('mobileCards').innerHTML=h;
}

// FORMATTERS
function fmtC(v){if(v==null||v===0)return null;return '$'+parseFloat(v).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});}
function fmtN(v){if(v==null||v===0)return null;return parseInt(v).toLocaleString();}
function fmtP(v){if(v==null||v===0)return null;return parseFloat(v).toFixed(1)+'%';}
function fmtShort(n){if(n==null||n===0)return '—';if(n>=1e6)return '$'+(n/1e6).toFixed(1)+'M';if(n>=1e3)return '$'+(n/1e3).toFixed(1)+'K';return '$'+n.toFixed(0);}
function truncate(s,m){if(!s)return '';return s.length>m?s.slice(0,m)+'…':s;}
function esc(s){var d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}

init();
</script>
</body>
</html>
